#!/bin/bash

# Setup the default gateway
SERVER_INTERFACE= `ip addr show | awk '/inet.*brd/{print $NF; exit}'`
GATEWAY=`ip route show default | awk '/default via/{print $3}'`
NAMESERVERS=`cat /etc/resolv.conf | awk '/nameserver/{print $2}'`
SERVERNAME=`cat /etc/tinc/local/hosts/master | grep Address | sed 's/Address=//g'`
SERVERIP=`dig $SERVERNAME | grep -v '^;' | grep 'IN A' | awk '{print $NF}'`

{% if 'tincvpn_'+tincvpn_network+'_ip' in hostvars[inventory_hostname] %}
ifconfig $INTERFACE {{ hostvars[inventory_hostname]['tincvpn_'+tincvpn_network+'_ip'] }} netmask {{ tincvpn_subnet|ipaddr('netmask') }}
{% endif %}


{% for route in tincvpn_routes %}
{% if route.network == 'default' %}
for ns in $NAMESERVERS; do
    ip route add $ns via $GATEWAY dev $SERVER_INTERFACE
done
ip route delete default
ip route add $SERVERIP via $GATEWAY dev $SERVER_INTERFACE
{% endif %}
ip route add {{ route.network }} via {{ route.gateway }} dev $INTERFACE
{% endfor %}